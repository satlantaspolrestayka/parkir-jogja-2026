<!DOCTYPE html>
<html>
<head>
    <title>Test Login Parkir Jogja</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Test Login Supabase</h1>
    
    <div>
        <h3>Email: unitkamselpolrestayka@gmail.com</h3>
        <h3>Password: unitkamsel123</h3>
    </div>
    
    <button onclick="testLogin()">Test Login</button>
    <button onclick="createUser()">Create User</button>
    <button onclick="listUsers()">List Users</button>
    
    <div id="result" style="margin-top: 20px; padding: 20px; background: #f0f0f0;"></div>
    
    <script>
        const SUPABASE_URL = 'https://ocjzmoyxcehxwbghbecx.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9janptb3l4Y2VoeHdiZ2hiZWN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MDQ5MjAsImV4cCI6MjA4NjI4MDkyMH0.5I3WhOHKcKOijje1bGqTihmcOr51myjLazz3d--IaIA';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        async function testLogin() {
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: 'unitkamselpolrestayka@gmail.com',
                    password: 'unitkamsel123'
                });
                
                if (error) {
                    document.getElementById('result').innerHTML = `
                        <div style="color: red;">
                            <h3>‚ùå LOGIN GAGAL</h3>
                            <p>Error: ${error.message}</p>
                            <p>Status: ${error.status}</p>
                        </div>
                    `;
                    return;
                }
                
                document.getElementById('result').innerHTML = `
                    <div style="color: green;">
                        <h3>‚úÖ LOGIN SUKSES!</h3>
                        <p>Email: ${data.user.email}</p>
                        <p>User ID: ${data.user.id}</p>
                        <p>Role: ${data.user.role}</p>
                        <p>Session expires: ${new Date(data.session.expires_at * 1000).toLocaleString()}</p>
                    </div>
                `;
                
                // Test update data
                await testUpdateData(data.session.access_token);
                
            } catch (err) {
                document.getElementById('result').innerHTML = `
                    <div style="color: red;">
                        <h3>‚ùå ERROR</h3>
                        <p>${err.message}</p>
                    </div>
                `;
            }
        }
        
        async function createUser() {
            // BUTUH SERVICE ROLE KEY untuk create user
            // Hanya untuk testing - jangan gunakan di production
            const SERVICE_KEY = prompt("Masukkan SERVICE_ROLE key dari Supabase:");
            
            if (!SERVICE_KEY) return;
            
            try {
                const response = await fetch(`${SUPABASE_URL}/auth/v1/admin/users`, {
                    method: 'POST',
                    headers: {
                        'apikey': SERVICE_KEY,
                        'Authorization': `Bearer ${SERVICE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'unitkamselpolrestayka@gmail.com',
                        password: 'unitkamsel123',
                        email_confirm: true
                    })
                });
                
                const result = await response.json();
                document.getElementById('result').innerHTML = `
                    <div style="background: ${response.ok ? 'green' : 'red'}; color: white; padding: 10px;">
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `;
                
            } catch (err) {
                document.getElementById('result').innerHTML = `
                    <div style="color: red;">
                        <h3>‚ùå CREATE USER ERROR</h3>
                        <p>${err.message}</p>
                    </div>
                `;
            }
        }
        
        async function listUsers() {
            try {
                const { data: { users }, error } = await supabase.auth.admin.listUsers();
                
                if (error) {
                    document.getElementById('result').innerHTML = `
                        <div style="color: red;">
                            <h3>‚ùå ERROR LISTING USERS</h3>
                            <p>${error.message}</p>
                        </div>
                    `;
                    return;
                }
                
                const userList = users.map(u => `
                    <div style="border: 1px solid #ccc; margin: 5px; padding: 10px;">
                        <strong>${u.email}</strong><br>
                        ID: ${u.id}<br>
                        Role: ${u.role}<br>
                        Confirmed: ${u.email_confirmed_at ? '‚úÖ' : '‚ùå'}<br>
                        Created: ${new Date(u.created_at).toLocaleString()}
                    </div>
                `).join('');
                
                document.getElementById('result').innerHTML = `
                    <div>
                        <h3>üìã Daftar Users (${users.length})</h3>
                        ${userList}
                    </div>
                `;
                
            } catch (err) {
                document.getElementById('result').innerHTML = `
                    <div style="color: red;">
                        <h3>‚ùå ERROR</h3>
                        <p>${err.message}</p>
                    </div>
                `;
            }
        }
        
        async function testUpdateData(token) {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/parkir_lokasi?id=eq.1`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({
                            bus: Math.floor(Math.random() * 100),
                            updated_at: new Date().toISOString()
                        })
                    }
                );
                
                if (response.ok) {
                    document.getElementById('result').innerHTML += `
                        <div style="color: green; margin-top: 10px;">
                            ‚úÖ UPDATE DATA SUKSES! Website publik akan otomatis update.
                        </div>
                    `;
                } else {
                    const error = await response.text();
                    document.getElementById('result').innerHTML += `
                        <div style="color: orange; margin-top: 10px;">
                            ‚ö†Ô∏è UPDATE DATA GAGAL: ${error}
                        </div>
                    `;
                }
            } catch (err) {
                document.getElementById('result').innerHTML += `
                    <div style="color: red; margin-top: 10px;">
                        ‚ùå UPDATE ERROR: ${err.message}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
