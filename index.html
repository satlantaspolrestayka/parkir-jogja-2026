// ====== KONFIGURASI SUPABASE ======
const SUPABASE_URL = 'https://ocjzmoyxcehxwbghbecx.supabase.co'; // GANTI
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9janptb3l4Y2VoeHdiZ2hiZWN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MDQ5MjAsImV4cCI6MjA4NjI4MDkyMH0.5I3WhOHKcKOijje1bGqTihmcOr51myjLazz3d--IaIA'; // GANTI

let supabaseClient = null;
let userPosition = null;
const distancesCache = new Map();
let isCalculating = false;

// ====== INISIALISASI SUPABASE ======
function initSupabase() {
    if (window.supabase) {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('‚úÖ Supabase initialized');
    }
}

// ====== FUNGSI LOAD DATA DARI SUPABASE ======
async function loadDataFromSupabase() {
    if (!supabaseClient) initSupabase();
    
    showLoading('Memuat data parkir terbaru...');
    
    try {
        const { data, error } = await supabaseClient
            .from('parkir_lokasi')
            .select('*')
            .order('id', { ascending: true });
        
        if (error) throw error;
        
        console.log('üìä Data loaded from Supabase:', data.length, 'locations');
        
        // Format data untuk kompatibilitas
        const formattedData = data.map(item => ({
            id: item.id,
            nama: item.nama,
            alamat: item.alamat,
            bus: item.bus || 0,
            mobil: item.mobil || 0,
            motor: item.motor || 0,
            koordinat: item.koordinat
        }));
        
        // Simpan ke variabel global
        window.dataParkir = formattedData;
        
        // Render ulang
        renderLokasi();
        updateTotalCounters();
        
        // Setup real-time subscription
        setupRealtimeUpdates();
        
        return formattedData;
        
    } catch (error) {
        console.error('‚ùå Error loading data:', error);
        
        // Fallback ke data statis
        alert('Gagal memuat data terbaru. Menggunakan data offline.');
        
        const staticData = [
            // ... (data statis yang lama) ...
        ];
        window.dataParkir = staticData;
        renderLokasi();
        updateTotalCounters();
        
        return staticData;
        
    } finally {
        hideLoading();
    }
}

// ====== REAL-TIME UPDATES ======
function setupRealtimeUpdates() {
    if (!supabaseClient) return;
    
    // Subscribe to changes
    const channel = supabaseClient
        .channel('parkir-updates')
        .on(
            'postgres_changes',
            {
                event: '*',
                schema: 'public',
                table: 'parkir_lokasi'
            },
            (payload) => {
                console.log('üîÑ Real-time update:', payload);
                
                // Update data lokal
                if (payload.eventType === 'UPDATE') {
                    const index = window.dataParkir.findIndex(item => item.id === payload.new.id);
                    if (index !== -1) {
                        window.dataParkir[index] = {
                            id: payload.new.id,
                            nama: payload.new.nama,
                            alamat: payload.new.alamat,
                            bus: payload.new.bus,
                            mobil: payload.new.mobil,
                            motor: payload.new.motor,
                            koordinat: payload.new.koordinat
                        };
                        
                        // Update UI spesifik untuk item ini
                        updateLokasiItemUI(payload.new.id, payload.new);
                        
                        // Update total counters
                        updateTotalCounters();
                        
                        // Show notification
                        showUpdateNotification(payload.new.nama);
                    }
                }
            }
        )
        .subscribe();
    
    console.log('üëÇ Listening for real-time updates');
}

function updateLokasiItemUI(lokasiId, newData) {
    const lokasiElement = document.querySelector(`.lokasi-item:nth-child(${lokasiId})`);
    if (!lokasiElement) return;
    
    // Update kapasitas badges
    const busBadge = lokasiElement.querySelector('.badge-bus .kap-number');
    const mobilBadge = lokasiElement.querySelector('.badge-mobil .kap-number');
    const motorBadge = lokasiElement.querySelector('.badge-motor .kap-number');
    
    if (busBadge && newData.bus > 0) busBadge.textContent = newData.bus;
    if (mobilBadge && newData.mobil > 0) mobilBadge.textContent = newData.mobil;
    if (motorBadge && newData.motor > 0) motorBadge.textContent = newData.motor;
    
    // Add visual feedback
    lokasiElement.style.backgroundColor = '#f0f9ff';
    setTimeout(() => {
        lokasiElement.style.backgroundColor = '';
    }, 1000);
}

function showUpdateNotification(namaLokasi) {
    // Create notification element
    const notification = document.createElement('div');
    notification.innerHTML = `
        <div style="position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999; animation: slideIn 0.3s ease-out;">
            üîÑ <strong>${namaLokasi}</strong> telah diperbarui
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// ====== UPDATE TOTAL COUNTERS ======
function updateTotalCounters() {
    if (!window.dataParkir) return;
    
    const totals = window.dataParkir.reduce((acc, lokasi) => {
        acc.bus += lokasi.bus || 0;
        acc.mobil += lokasi.mobil || 0;
        acc.motor += lokasi.motor || 0;
        return acc;
    }, { bus: 0, mobil: 0, motor: 0 });
    
    // Update compact header
    const busTab = document.querySelector('.tab-bus .tab-number');
    const mobilTab = document.querySelector('.tab-mobil .tab-number');
    const motorTab = document.querySelector('.tab-motor .tab-number');
    
    if (busTab) busTab.textContent = totals.bus.toLocaleString();
    if (mobilTab) mobilTab.textContent = totals.mobil.toLocaleString();
    if (motorTab) motorTab.textContent = totals.motor.toLocaleString();
    
    // Update total locations
    document.querySelector('.total-number').textContent = window.dataParkir.length;
}

// ====== FUNGSI UTAMA (tidak banyak berubah) ======
function hitungJarak(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function formatJarak(km) {
    if (km < 1) {
        return `${Math.round(km * 1000)} meter`;
    } else {
        return `${km.toFixed(1)} km`;
    }
}

async function getLocation() {
    return new Promise((resolve, reject) => {
        if (userPosition) {
            resolve(userPosition);
            return;
        }
        
        if (isCalculating) {
            reject(new Error('Sedang menghitung lokasi...'));
            return;
        }
        
        if (!navigator.geolocation) {
            reject(new Error('Browser tidak mendukung GPS'));
            return;
        }
        
        showLoading('Mendeteksi lokasi Anda...');
        isCalculating = true;
        
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                userPosition = {
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude
                };
                hideLoading();
                isCalculating = false;
                resolve(userPosition);
            },
            (err) => {
                hideLoading();
                isCalculating = false;
                reject(err);
            },
            {
                enableHighAccuracy: true,
                timeout: 8000,
                maximumAge: 0
            }
        );
    });
}

async function hitungSemuaJarak() {
    if (!userPosition || !window.dataParkir) return;
    
    showLoading('Menghitung jarak ke lokasi parkir...');
    
    distancesCache.clear();
    
    for (const lokasi of window.dataParkir) {
        try {
            const [lokasiLat, lokasiLng] = lokasi.koordinat.split(',').map(Number);
            const jarak = hitungJarak(
                userPosition.lat,
                userPosition.lng,
                lokasiLat,
                lokasiLng
            );
            distancesCache.set(lokasi.id, jarak);
            
            updateJarakDisplay(lokasi.id, jarak);
            
            await delay(50);
        } catch (error) {
            console.error(`Error menghitung jarak untuk ${lokasi.nama}:`, error);
            distancesCache.set(lokasi.id, Infinity);
        }
    }
    
    hideLoading();
}

function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

function showLoading(message) {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        const text = overlay.querySelector('.loading-text');
        if (text && message) {
            text.textContent = message;
        }
        overlay.classList.add('active');
    }
}

function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.classList.remove('active');
    }
}

async function cariParkirTerdekat() {
    const btn = document.getElementById('btnCari');
    if (!btn) return;
    
    btn.disabled = true;
    btn.innerHTML = '<span>üìç</span> MENGHITUNG...';
    
    try {
        if (!userPosition) {
            await getLocation();
        }
        
        if (distancesCache.size === 0) {
            await hitungSemuaJarak();
        }
        
        // Sort berdasarkan jarak
        window.dataParkir.sort((a, b) => {
            const jarakA = distancesCache.get(a.id) || Infinity;
            const jarakB = distancesCache.get(b.id) || Infinity;
            return jarakA - jarakB;
        });
        
        // Render ulang
        renderLokasi();
        
        // Highlight yang terdekat
        highlightClosestParking();
        
        console.log('‚úÖ Parkir berhasil diurutkan berdasarkan jarak');
        
    } catch (error) {
        console.error('Error mengurutkan parkir:', error);
        
        if (error.code === 1) {
            alert('Izinkan akses lokasi untuk mengurutkan parkir terdekat.');
        } else if (error.message === 'Timeout') {
            alert('Waktu habis. Pastikan GPS aktif dan coba lagi.');
        } else {
            alert('Tidak dapat mengakses lokasi Anda.');
        }
        
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>üìç</span> CARI PARKIR TERDEKAT';
    }
}

function highlightClosestParking() {
    // Remove existing highlights
    document.querySelectorAll('.lokasi-item').forEach(item => {
        item.classList.remove('closest');
    });
    
    // Add highlight to first item (closest)
    const firstItem = document.querySelector('.lokasi-item');
    if (firstItem) {
        firstItem.classList.add('closest');
        
        // Scroll to top
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }
}

function renderLokasi() {
    const container = document.getElementById('lokasiList');
    if (!container || !window.dataParkir) return;
    
    let html = '';
    
    window.dataParkir.forEach((lokasi, index) => {
        const jarak = distancesCache.get(lokasi.id);
        const jarakText = jarak !== undefined ? 
            `üìè ${formatJarak(jarak)} dari lokasi Anda` : 
            'üìè Mendeteksi lokasi...';
        const jarakClass = jarak !== undefined ? '' : 'lokasi-jarak-loading';
        
        html += `
            <div class="lokasi-item">
                <div class="lokasi-header">
                    <div class="lokasi-nama">${lokasi.nama}</div>
                    <div class="lokasi-id">${index + 1}</div>
                </div>
                <div class="lokasi-alamat">${lokasi.alamat}</div>
                <div class="lokasi-jarak ${jarakClass}">
                    ${jarakText}
                </div>
                <div class="kapasitas-container">
                    ${lokasi.bus > 0 ? `
                        <span class="kap-badge badge-bus">
                            <span class="kap-icon">üöå</span>
                            <span class="kap-number">${lokasi.bus}</span>
                            <span class="kap-label">Bus</span>
                        </span>
                    ` : ''}
                    ${lokasi.mobil > 0 ? `
                        <span class="kap-badge badge-mobil">
                            <span class="kap-icon">üöó</span>
                            <span class="kap-number">${lokasi.mobil}</span>
                            <span class="kap-label">Mobil</span>
                        </span>
                    ` : ''}
                    ${lokasi.motor > 0 ? `
                        <span class="kap-badge badge-motor">
                            <span class="kap-icon">üèçÔ∏è</span>
                            <span class="kap-number">${lokasi.motor}</span>
                            <span class="kap-label">Motor</span>
                        </span>
                    ` : ''}
                </div>
                <div class="lokasi-actions">
                    <button class="btn-action btn-map" onclick="bukaLokasiDiMaps('${lokasi.koordinat}', '${lokasi.nama}')">
                        <span>üó∫Ô∏è</span> Lihat di Maps
                    </button>
                    <button class="btn-action btn-route" onclick="ruteKeLokasi('${lokasi.koordinat}', '${lokasi.nama}')">
                        <span>üìç</span> Rute ke Sini
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function bukaLokasiDiMaps(koordinat, nama) {
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    
    if (isIOS) {
        window.location.href = `maps://?q=${koordinat}&z=16`;
        
        setTimeout(() => {
            if (document.hasFocus()) {
                window.open(`https://maps.google.com/?q=${koordinat}`, '_blank');
            }
        }, 500);
    } else {
        window.open(`https://maps.google.com/?q=${koordinat}`, '_blank');
    }
}

function ruteKeLokasi(koordinat, nama) {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const userLat = pos.coords.latitude;
                const userLng = pos.coords.longitude;
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                
                if (isIOS) {
                    window.location.href = `maps://?saddr=${userLat},${userLng}&daddr=${koordinat}&dirflg=d`;
                    
                    setTimeout(() => {
                        if (document.hasFocus()) {
                            window.open(`https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLng}&destination=${koordinat}&travelmode=driving`, '_blank');
                        }
                    }, 500);
                } else {
                    window.open(`https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLng}&destination=${koordinat}&travelmode=driving`, '_blank');
                }
            },
            () => {
                alert('Tidak dapat mendeteksi lokasi Anda.');
            }
        );
    } else {
        alert('Browser tidak mendukung navigasi lokasi.');
    }
}

// ====== INISIALISASI ======
document.addEventListener('DOMContentLoaded', async () => {
    // Load Supabase JS library
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
    document.head.appendChild(script);
    
    script.onload = async () => {
        initSupabase();
        await loadDataFromSupabase();
        
        try {
            await getLocation();
            await hitungSemuaJarak();
        } catch (error) {
            console.log('Lokasi tidak tersedia:', error.message);
        }
    };
    
    // Auto-refresh setiap 30 detik
    setInterval(async () => {
        await loadDataFromSupabase();
    }, 30000);
});
